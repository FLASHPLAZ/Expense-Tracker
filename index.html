<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Expense Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-track { background-color: #f3f4f6; }
    </style>
</head>
<body class="min-h-screen antialiased">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-10">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-gray-800 tracking-tighter">BudgetFlow Pro (INR)</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-2">Connecting to secure storage...</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-spinner" class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-600"></div>
            <p class="ml-4 text-lg text-gray-600">Loading data and authenticating...</p>
        </div>
        
        <!-- *** Configuration Error Message (Hidden by default) *** -->
        <div id="config-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 p-6 rounded-xl my-8">
            <p class="font-bold text-xl mb-3">CRITICAL ERROR: Firebase Configuration Issue</p>
            <p class="mb-3">This application failed to connect to the database. This could be due to incorrect configuration or missing **Firebase Firestore Security Rules**.</p>
            <p class="mb-3 font-mono text-sm bg-red-50 p-2 rounded">
                If the error persists after checking the console, please ensure your Firestore rules allow anonymous read/write access to the `artifacts` collection.
            </p>
            <p id="detailed-error" class="mt-4 text-sm font-semibold italic"></p>
        </div>


        <!-- Main Content (Hidden until loaded) -->
        <div id="main-content" class="hidden">

            <!-- Summary Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="p-6 bg-white rounded-xl shadow-lg border-b-4 border-green-500">
                    <p class="text-sm font-semibold text-gray-500">TOTAL INCOME</p>
                    <p id="total-income" class="text-3xl font-extrabold text-green-600 mt-2">‚Çπ0.00</p>
                </div>
                <div class="p-6 bg-white rounded-xl shadow-lg border-b-4 border-red-500">
                    <p class="text-sm font-semibold text-gray-500">TOTAL EXPENSES</p>
                    <p id="total-expense" class="text-3xl font-extrabold text-red-600 mt-2">‚Çπ0.00</p>
                </div>
                <div id="balance-card" class="p-6 bg-indigo-600 rounded-xl shadow-lg text-white transition duration-300 ease-in-out">
                    <p class="text-sm font-semibold">NET BALANCE (Filtered)</p>
                    <p id="net-balance" class="text-3xl font-extrabold mt-2">‚Çπ0.00</p>
                </div>
            </div>

            <!-- Transaction Form & Filtering Controls -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

                <!-- Add Transaction Form -->
                <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Add New Transaction</h2>
                    <form id="transaction-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                <input type="text" id="description" required placeholder="e.g., Grocery run, Monthly Salary" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700">Amount (‚Çπ)</label>
                                <input type="number" id="amount" required min="0.01" step="0.01" placeholder="0.00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                                <select id="type" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500 appearance-none bg-white">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                <input type="text" id="category" placeholder="e.g., Food, Salary, Rent" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>

                        <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out font-semibold">
                            Record Transaction
                        </button>
                        <div id="form-message" class="text-center text-sm hidden p-2 rounded-lg"></div>
                    </form>
                </div>
                
                <!-- Reporting & Filter Controls -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-between space-y-4">
                    <h2 class="text-xl font-semibold mb-2 text-gray-700 border-b pb-2">Report & Filter</h2>
                    <div class="space-y-3">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="start-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="end-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <button id="apply-filter-btn" class="w-full py-3 px-4 border border-transparent rounded-lg text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out font-semibold">
                        Apply Filter
                    </button>
                    
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button id="download-pdf-btn" class="py-3 px-2 border border-transparent rounded-lg shadow-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out font-semibold text-sm">
                            Download PDF Report
                        </button>
                        <button id="view-pdf-btn" class="py-3 px-2 border border-transparent rounded-lg shadow-md text-white bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 transition duration-150 ease-in-out font-semibold text-sm">
                            View PDF in Popup
                        </button>
                    </div>

                    <p id="filter-message" class="text-xs text-center text-gray-500 hidden"></p>
                </div>
            </div>


            <!-- Transaction List -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Transaction History</h2>
                <div id="transactions-list" class="space-y-3">
                    <p id="no-transactions" class="text-gray-500 text-center py-8">No transactions found for the selected filter.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-10 py-4 text-center text-gray-500 text-sm border-t border-gray-200">
        Expense Tracker made by Raj
    </footer>
    
    <!-- *** FIREBASE CONFIGURATION INSTRUCTIONS (Hidden since config is provided) *** -->
    <div class="max-w-5xl mx-auto p-4 md:p-10 mt-6 bg-yellow-50 rounded-xl shadow-lg border border-yellow-300 hidden" id="config-instructions">
        <h3 class="text-xl font-bold text-yellow-800 mb-3">üõ†Ô∏è Setup Required: Configure Firebase</h3>
        <p class="text-gray-700 mb-4">
            Since you are hosting this app outside of the Canvas environment, the database connection is currently failing. You must replace the placeholder configuration in the script below with your own project's keys.
        </p>
    </div>

    <!-- Simple Modal for Confirmation (replacing window.confirm) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-semibold mb-3 text-gray-800">Confirm Action</h3>
            <p id="modal-message" class="mb-5 text-gray-600">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="py-2 px-4 rounded-lg text-gray-600 hover:bg-gray-100">Cancel</button>
                <button id="modal-confirm-btn" class="py-2 px-4 rounded-lg text-white bg-red-600 hover:bg-red-700 transition duration-150">Confirm Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, deleteDoc, Timestamp, setLogLevel, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // !!! FIREBASE CONFIGURATION (Provided by User) !!!
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD91Bdh-zdW7WA_Sy1x38838t5g4PXPqeQ",
            authDomain: "studio-4962783013-f5286.firebaseapp.com",
            projectId: "studio-4962783013-f5286",
            storageBucket: "studio-4962783013-f5286.firebasestorage.app",
            messagingSenderId: "276373167401",
            appId: "1:276373167401:web:ef0531dd4bfc7aa5016b38"
        };
        
        // This acts as a persistent identifier for this application instance
        const appId = 'budgetflow-pro-hosted';

        // Global Firebase and App variables
        let app;
        let db;
        let auth;
        let userId;
        let transactionsData = []; // Stores ALL data from Firestore
        let filteredData = []; // Stores currently filtered data for display/report

        // Constants
        // Data is stored in a public collection under the unique app ID for simplicity
        const TRANSACTIONS_COLLECTION_PATH = () => 
            `/artifacts/${appId}/public/data/transactions`;

        // Get references to DOM elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainContent = document.getElementById('main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const transactionList = document.getElementById('transactions-list');
        const formMessage = document.getElementById('form-message');
        const filterMessage = document.getElementById('filter-message');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const viewPdfBtn = document.getElementById('view-pdf-btn');
        const transactionForm = document.getElementById('transaction-form');
        const balanceCard = document.getElementById('balance-card');
        const configErrorMessage = document.getElementById('config-error-message');
        const detailedError = document.getElementById('detailed-error');
        const configInstructions = document.getElementById('config-instructions');

        // Set today's date as default for new transaction
        document.getElementById('date').valueAsDate = new Date();


        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                // Set the instructions to hidden, as the config is now provided
                configInstructions.classList.add('hidden');

                // 1. Initialize Firebase App
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                // 2. Authenticate Anonymously
                await signInAnonymously(auth);

                // 3. Setup Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId} (Anonymous session)`;
                        loadingSpinner.classList.add('hidden');
                        configErrorMessage.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        setupRealtimeListener(); // Call listener without UID, as path is public
                        applyFilterBtn.click(); // Initial render with no filters applied
                    } else {
                        userId = null;
                        // This case is unlikely right after signInAnonymously succeeds, but handles external logouts.
                        loadingSpinner.innerHTML = `<p class="text-red-500">Authentication lost. Please reload the page.</p>`;
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                
                // Show the specific configuration error on the screen
                loadingSpinner.classList.add('hidden');
                configErrorMessage.classList.remove('hidden');
                detailedError.textContent = `Technical Error: ${error.message || 'Unknown initialization failure.'}`;
                
                // Keep the default loading message updated with the basic error
                userIdDisplay.textContent = "Configuration Error: Check console and security rules.";
            }
        }
        
        /**
         * Sets up the real-time listener for ALL transactions in the public collection.
         */
        function setupRealtimeListener() {
            // We fetch ALL data ordered by timestamp descending, and filter client-side.
            const q = query(collection(db, TRANSACTIONS_COLLECTION_PATH()), orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                transactionsData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure amount is stored and parsed as a number
                    const amountValue = typeof data.amount === 'string' ? parseFloat(data.amount) : data.amount;

                    transactionsData.push({
                        id: doc.id,
                        description: data.description,
                        amount: amountValue,
                        type: data.type,
                        category: data.category || 'General',
                        date: data.date, 
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                    });
                });
                applyFilter(); // Re-filter and re-render the view whenever data changes
            }, (error) => {
                console.error("Error fetching transactions:", error);
                // Check if the error is a permission denied error (common with bad config/rules)
                if (error.code === 'permission-denied') {
                     showFormMessage('Error: Access Denied. Check your Firebase Rules.', 'error');
                     // Update the main error message as well if the listener fails due to rules
                     configErrorMessage.classList.remove('hidden');
                     detailedError.textContent = `Security Error: Firestore permission denied. Check your Firestore Security Rules to allow anonymous read/write access.`;
                } else {
                     showFormMessage('Error loading transactions. Check console.', 'error');
                }
            });
        }

        /**
         * Applies the date filter to the transactionsData and updates the display.
         */
        function applyFilter() {
            const start = startDateInput.value ? new Date(startDateInput.value) : null;
            const end = endDateInput.value ? new Date(endDateInput.value) : null;

            // Set end date to midnight of the next day to include the entire end day
            if (end) {
                // Clone the date to avoid modifying the original
                const inclusiveEnd = new Date(end.getTime()); 
                inclusiveEnd.setDate(inclusiveEnd.getDate() + 1);
                end = inclusiveEnd;
            }

            filteredData = transactionsData.filter(t => {
                const transactionDate = t.timestamp;
                const afterStart = !start || transactionDate >= start;
                const beforeEnd = !end || transactionDate < end;
                return afterStart && beforeEnd;
            });

            renderTransactions(filteredData);
            updateFilterMessage(start, end);
        }

        /**
         * Updates the filter message display.
         */
        function updateFilterMessage(start, end) {
             const message = [];
             if (startDateInput.value) {
                 message.push(`From: ${startDateInput.value}`);
             }
             if (endDateInput.value) {
                 message.push(`To: ${endDateInput.value}`);
             }
             
             filterMessage.classList.remove('hidden');
             if (message.length === 0) {
                 filterMessage.textContent = 'Showing all transactions.';
             } else {
                 filterMessage.textContent = `Active Filter: ${message.join(' | ')}`;
             }
        }

        /**
         * Renders the summary dashboard and transaction list based on filtered data.
         */
        function renderTransactions(transactions) {
            const income = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const balance = income - expense;

            // Update Summary
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expense').textContent = formatCurrency(expense);
            document.getElementById('net-balance').textContent = formatCurrency(balance);
            
            balanceCard.classList.remove('bg-green-600', 'bg-red-600', 'bg-indigo-600');
            if (balance > 0) {
                balanceCard.classList.add('bg-green-600');
            } else if (balance < 0) {
                balanceCard.classList.add('bg-red-600');
            } else {
                 balanceCard.classList.add('bg-indigo-600');
            }

            // Update List
            transactionList.innerHTML = ''; 

            if (transactions.length === 0) {
                // Use a separate element to ensure it's removed if transactions appear
                const noTrans = document.getElementById('no-transactions') || document.createElement('p');
                noTrans.id = 'no-transactions';
                noTrans.className = 'text-gray-500 text-center py-8';
                noTrans.textContent = 'No transactions found for the selected filter.';
                transactionList.appendChild(noTrans);
                return;
            }

            // Remove the 'no transactions' message if it exists
             const existingNoTrans = document.getElementById('no-transactions');
             if (existingNoTrans) {
                 existingNoTrans.remove();
             }

            transactions.forEach(t => {
                const isExpense = t.type === 'expense';
                const color = isExpense ? 'text-red-600' : 'text-green-600';
                const sign = isExpense ? '-' : '+';
                const dateDisplay = new Date(t.date || t.timestamp).toLocaleDateString();

                const item = document.createElement('div');
                item.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-xl shadow-sm border ${isExpense ? 'border-red-100' : 'border-green-100'} hover:shadow-md transition duration-150`;
                item.innerHTML = `
                    <div class="flex-1 min-w-0 mb-2 sm:mb-0">
                        <p class="font-medium text-lg text-gray-800 truncate">${t.description}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="font-semibold">${t.category}</span> &bull; 
                            ${dateDisplay}
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <p class="font-bold ${color} text-xl whitespace-nowrap">
                            ${sign}${formatCurrency(t.amount, false)}
                        </p>
                        <button data-id="${t.id}" class="delete-btn text-gray-400 hover:text-red-500 transition duration-150 p-1 rounded-full hover:bg-red-50 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionList.appendChild(item);
            });
        }

        /**
         * Formats a number as currency (INR).
         */
        function formatCurrency(amount, includeSymbol = true) {
             const formatted = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
            }).format(amount);

            return includeSymbol ? formatted : formatted.replace('‚Çπ', '').trim();
        }

        /**
         * Shows a temporary message above the submit button.
         */
        function showFormMessage(message, type) {
            formMessage.textContent = message;
            formMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (type === 'success') {
                formMessage.classList.add('bg-green-100', 'text-green-800');
            } else {
                formMessage.classList.add('bg-red-100', 'text-red-800');
            }
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 3000);
        }

        /**
         * Custom Modal logic for confirmation (since window.confirm is restricted).
         */
        function customConfirm(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-message').textContent = message;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const confirmAction = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    document.getElementById('modal-confirm-btn').removeEventListener('click', confirmAction);
                    document.getElementById('modal-cancel-btn').removeEventListener('click', cancelAction);
                    resolve(true);
                };

                const cancelAction = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    document.getElementById('modal-confirm-btn').removeEventListener('click', confirmAction);
                    document.getElementById('modal-cancel-btn').removeEventListener('click', cancelAction);
                    resolve(false);
                };

                document.getElementById('modal-confirm-btn').addEventListener('click', confirmAction);
                document.getElementById('modal-cancel-btn').addEventListener('click', cancelAction);
            });
        }
        
        /**
         * Generates the jsPDF document object based on current filtered data.
         */
        function createPDFDocument() {
            // Check if libraries are loaded
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
                showFormMessage("Error: PDF library failed to load completely.", 'error');
                return null;
            }

            if (filteredData.length === 0) {
                showFormMessage("Cannot generate report: No transactions match the current filter.", 'error');
                return null;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const start = startDateInput.value || 'Beginning';
            const end = endDateInput.value || 'Today';
            
            // Calculate summary for the report
            const income = filteredData.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expense = filteredData.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const balance = income - expense;

            // Header
            doc.setFontSize(18);
            doc.text("Expense Tracker Report: BudgetFlow Pro (INR)", 14, 20);
            doc.setFontSize(10);
            doc.text(`Report Period: ${start} to ${end}`, 14, 28);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 33);
            
            let yOffset = 45;

            // Summary Table
            doc.autoTable({
                startY: yOffset,
                head: [['Metric', 'Amount (‚Çπ)']],
                body: [
                    ['Total Income', formatCurrency(income)],
                    ['Total Expenses', formatCurrency(expense)],
                    ['Net Balance', formatCurrency(balance)],
                ],
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] }, // Tailwind indigo-600
                styles: { fontSize: 10 },
                columnStyles: { 1: { fontStyle: 'bold' } },
                didDrawPage: (data) => {
                    doc.setFontSize(8);
                    doc.text(`Page ${data.pageNumber} of ${doc.internal.pages.length - 1}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            yOffset = doc.autoTable.previous.finalY + 10;
            
            // Transaction Details Header
            doc.setFontSize(14);
            doc.text("Transaction Details", 14, yOffset);
            yOffset += 5;

            // Details Table
            const tableData = filteredData.map(t => [
                new Date(t.date || t.timestamp).toLocaleDateString(),
                t.description,
                t.category,
                t.type,
                (t.type === 'expense' ? '-' : '+') + formatCurrency(t.amount, false)
            ]);

            doc.autoTable({
                startY: yOffset + 5,
                head: [['Date', 'Description', 'Category', 'Type', 'Amount (‚Çπ)']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [55, 65, 81] }, // Tailwind gray-700
                styles: { fontSize: 9 },
                didDrawPage: (data) => {
                    doc.setFontSize(8);
                    doc.text(`Page ${data.pageNumber}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            return doc;
        }

        /**
         * Handles the PDF download process.
         */
        function handleDownloadPDF() {
             const originalText = downloadPdfBtn.textContent;
             
             downloadPdfBtn.textContent = 'Generating...';
             downloadPdfBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
             downloadPdfBtn.classList.remove('bg-red-600', 'hover:bg-red-700');

            try {
                const doc = createPDFDocument();
                if (!doc) {
                     downloadPdfBtn.textContent = originalText; // Reset on failure
                     downloadPdfBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                     downloadPdfBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    return;
                }

                const start = startDateInput.value || 'Beginning';
                const end = endDateInput.value || 'Today';
                doc.save(`Expense_Report_${start}_to_${end}.pdf`);
                
                downloadPdfBtn.textContent = 'Downloaded!';
                downloadPdfBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                downloadPdfBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                setTimeout(() => {
                    downloadPdfBtn.textContent = originalText;
                    downloadPdfBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    downloadPdfBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                }, 2000);

            } catch (error) {
                console.error("PDF Generation failed:", error);
                showFormMessage(`Download failed: ${error.message}. Check console.`, 'error');
                downloadPdfBtn.textContent = 'Error: Try Again';
                downloadPdfBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                downloadPdfBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                setTimeout(() => {
                    downloadPdfBtn.textContent = originalText;
                    downloadPdfBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    downloadPdfBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                }, 3000);
            }
        }
        
        /**
         * Handles viewing the PDF in a new window/popup.
         */
        function handleViewPDFInPopup() {
             const originalText = viewPdfBtn.textContent;
             
             viewPdfBtn.textContent = 'Generating...';
             viewPdfBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
             viewPdfBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');

            try {
                const doc = createPDFDocument();
                if (!doc) {
                     viewPdfBtn.textContent = originalText; // Reset on failure
                     viewPdfBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                     viewPdfBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                    return;
                }
                
                // Get PDF as Blob and create a URL for viewing
                const blob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(blob);
                window.open(pdfUrl, '_blank');

                viewPdfBtn.textContent = 'Viewed!';
                viewPdfBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                viewPdfBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                setTimeout(() => {
                    viewPdfBtn.textContent = originalText;
                    viewPdfBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    viewPdfBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                }, 2000);

            } catch (error) {
                console.error("Popup View failed:", error);
                showFormMessage(`Popup View failed: ${error.message}. Check console.`, 'error');
                viewPdfBtn.textContent = 'Error: Try Again';
                viewPdfBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                viewPdfBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                setTimeout(() => {
                    viewPdfBtn.textContent = originalText;
                    viewPdfBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    viewPdfBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                }, 3000);
            }
        }


        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', initFirebase);
        
        // Handle Add Transaction form submission
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showFormMessage('App not ready. Please wait for authentication.', 'error');
                return;
            }

            const description = document.getElementById('description').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value.trim() || 'General';
            const date = document.getElementById('date').value;

            if (!description || isNaN(amount) || amount <= 0 || !date) {
                showFormMessage('Please ensure all fields (Description, Amount, Date) are valid.', 'error');
                return;
            }

            // Create a Date object from the date input to get a proper Firestore Timestamp
            const transactionDate = new Date(date);

            const newTransaction = {
                description,
                amount: amount.toFixed(2), 
                type,
                category,
                date: date, // Store readable date string
                timestamp: Timestamp.fromDate(transactionDate), // Store Timestamp for ordering/filtering
                userId: userId 
            };

            try {
                // Since we are using the public collection, we don't pass UID to the path function
                await addDoc(collection(db, TRANSACTIONS_COLLECTION_PATH()), newTransaction);
                showFormMessage('Transaction recorded successfully!', 'success');
                e.target.reset(); // Clear form
                document.getElementById('date').valueAsDate = new Date(); // Reset date field to today
            } catch (error) {
                console.error("Error adding document: ", error);
                showFormMessage('Failed to record transaction. Check console.', 'error');
            }
        });
        
        // Handle filter application
        applyFilterBtn.addEventListener('click', applyFilter);

        // Handle PDF actions
        downloadPdfBtn.addEventListener('click', handleDownloadPDF);
        viewPdfBtn.addEventListener('click', handleViewPDFInPopup);


        // Handle Delete Transaction button clicks using event delegation
        transactionList.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const docId = deleteButton.dataset.id;
                
                const confirmed = await customConfirm('Are you sure you want to permanently delete this transaction? This action cannot be undone.');
                
                if (!confirmed || !userId) return;

                try {
                    // Since we are using the public collection, we don't pass UID to the path function
                    await deleteDoc(doc(db, TRANSACTIONS_COLLECTION_PATH(), docId));
                    showFormMessage('Transaction deleted.', 'success');
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showFormMessage('Failed to delete transaction. Check console.', 'error');
                }
            }
        });

    </script>
</body>
</html>

